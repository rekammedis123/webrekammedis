<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin IMUT Pendaftaran | Medical Record</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="icon" href="logorekammedis.ico">

<style>
:root{
  --green:#16a34a;
  --bg:#ffffff;
  --line:#e5e7eb;
}
*{box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{margin:0;background:var(--bg)}
.layout{display:flex;min-height:100vh}

/* SIDEBAR */
.sidebar{
  width:260px;
  background:linear-gradient(180deg,#16a34a,#15803d);
  color:#fff;
  padding:25px 20px;
}
.brand{text-align:center;margin-bottom:40px}
.brand i{font-size:42px}
.brand h2{margin:10px 0 0;font-size:20px}

.menu a{
  display:flex;gap:14px;align-items:center;
  padding:14px 18px;margin-bottom:14px;
  color:#fff;text-decoration:none;
  border-radius:14px;
  transition:.3s;
}
.menu a:hover,.menu a.active{
  background:rgba(255,255,255,.18);
  transform:translateX(6px);
}

/* CONTENT */
.content{
  flex:1;
  padding:35px;
  opacity:0;
  transform:translateY(20px);
  transition:.6s;
}
.content.show{opacity:1;transform:none}

.header{
  display:flex;justify-content:space-between;align-items:center;
  margin-bottom:30px;
}
.header h1{margin:0;color:#166534}

.logout{
  background:#ef4444;color:#fff;
  border:none;padding:10px 16px;
  border-radius:999px;cursor:pointer;
}

/* CARD */
.card{
  background:#fff;
  border-radius:18px;
  padding:26px;
  margin-bottom:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);
  opacity:0;
  transform:translateY(20px);
  transition:.5s;
}
.card.show{opacity:1;transform:none}

label{font-size:13px;color:#166534}
select,input{
  padding:8px;
  border-radius:10px;
  border:1px solid var(--line);
  margin:6px 0 14px;
}

/* TABLE */
.table-wrapper{overflow-x:auto}
table{
  width:100%;
  border-collapse:collapse;
  min-width:700px;
}
th,td{
  border:1px solid var(--line);
  padding:4px;
  text-align:center;
  font-size:12px;
  white-space:nowrap;
}
th{background:var(--green);color:#fff}
td input{
  width:42px;
  padding:4px;
  font-size:12px;
  text-align:center;
}

/* ===== SUB MENU IMUT ===== */
.menu-toggle{
  justify-content:space-between;
}

.arrow{
  margin-left:auto;
  transition:.3s;
}

.submenu{
  max-height:0;
  overflow:hidden;
  margin-left:25px;
  transition:max-height .35s ease;
}

.submenu a{
  font-size:14px;
  padding:10px 18px;
  margin-bottom:8px;
  background:rgba(255,255,255,.12);
  border-radius:12px;
}

.submenu.show{
  max-height:350px;
}

.submenu.show ~ .menu-toggle .arrow{
  transform:rotate(180deg);
}


/* BUTTON */
button.primary{
  background:var(--green);
  color:#fff;border:none;
  padding:12px 20px;
  border-radius:12px;
  cursor:pointer;
}

/* SUMMARY */
.summary{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(200px,1fr));
  gap:18px;
}
.summary .box{
  background:#f0fdf4;
  border-radius:16px;
  padding:20px;
  text-align:center;
}
.summary h2{margin:0;color:#065f46}

/* LOADING */
.loading{
  position:fixed;inset:0;
  background:rgba(0,0,0,.25);
  display:flex;align-items:center;justify-content:center;
  opacity:0;pointer-events:none;
}
.loading.show{opacity:1;pointer-events:auto}
.spinner{
  width:30px;height:30px;
  border:3px solid #bbf7d0;
  border-top:3px solid var(--green);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

footer{text-align:center;font-size:13px;color:#166534;margin-top:40px}

@media(max-width:900px){
  .layout{flex-direction:column}
  .sidebar{width:100%}
}
</style>
</head>

<body>

<div class="loading" id="loading"><div class="spinner"></div></div>

<div class="layout">

<aside class="sidebar">
    <div class="brand">
      <i class="fas fa-notes-medical"></i>
      <h2>ADMIN MR</h2>
    </div>
    <nav class="menu">
      <a href="admin_index.html"><i class="fas fa-gauge-high"></i> Dashboard</a>
      <a href="admin_regulasi.html"><i class="fas fa-file-medical"></i> Regulasi</a>
      <a href="admin_kunjungan.html"><i class="fas fa-chart-simple"></i> Kunjungan Pasien</a>
      <a href="admin_pemusnahan.html"><i class="fas fa-trash"></i> Pemusnahan</a>
      <a href="javascript:void(0)" class="menu-toggle" onclick="toggleImut()">
        <i class="fas fa-chart-line"></i>
        <span>IMUT</span>
        <i class="fas fa-chevron-down arrow" id="imutArrow"></i>
      </a>

      <div class="submenu" id="imutSubmenu">
        <a href="admin_imutrekammedis.html">
            <i class="fas fa-file-medical"></i>Rekam Medis
        </a>
        <a href="admin_imutpendaftaran.html">
            <i class="fas fa-user-plus"></i>Pendaftaran
        </a>
        <a href="admin_imutcustomercare.html">
            <i class="fas fa-headset"></i>Customer Care
        </a>
    </div>

      <a href="admin_indikatorbor.html"><i class="fas fa-chart-simple"></i> Indikator</a>
    </nav>
  </aside>

<main class="content" id="content">

<div class="header">
  <h1>IMUT Customer Care â€“ Reminder Pasien</h1>
  <button class="logout" onclick="logout()">Logout</button>
</div>

<div class="card">
<h3>Filter</h3>
<label>Mode</label>
<select id="mode">
  <option value="harian">Harian</option>
  <option value="tahunan">Tahunan</option>
</select>
<label>Bulan</label>
<select id="bulan"></select>

<label>Tahun</label>
<select id="tahun"></select>

<button class="primary" onclick="loadData()">Tampilkan</button>
</div>

<div class="card">
<h3>Input Harian</h3>
<div class="table-wrapper">
<table>
<thead><tr id="tglHeader"></tr></thead>
<tbody>
<tr id="numRow"></tr>
<tr id="denRow"></tr>
</tbody>
</table>
</div><br>
<button class="primary" onclick="simpan()">ðŸ’¾ Simpan Data</button>
</div>

<div class="card">
<h3>Ringkasan</h3>
<div class="summary">
  <div class="box"><p>Target</p><h2 id="targetVal">0%</h2></div>
  <div class="box"><p>Capaian</p><h2 id="persen">0%</h2></div>
  <div class="box"><p>Total Pasien</p><h2 id="Totalpasien">0</h2></div>
</div>
</div>

<div class="card">
<h3>Grafik Harian SEP</h3>
<div style="height:420px"><canvas id="chart"></canvas></div>
</div>

<footer>Â© 2025 Admin Medical Record RSU An Ni'mah</footer>

</main>
</div>

<script>
/* AUTH */
if(sessionStorage.getItem("adminLogin")!=="true") location.href="admin_index.html";

/* KONFIG */
const API="https://script.google.com/macros/s/AKfycbzV1YGA3jkKJl7hVpy7j6yAZhoqt1MSkKOK8OJ6OruWa4E9vJkhdTu6A_WDEhouPqHx/exec";
const indikator="customercare"; // DIKUNCI
const bulanArr=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];

const bulanSel=document.getElementById("bulan");
const tahunSel=document.getElementById("tahun");
const loading=document.getElementById("loading");
const cards=document.querySelectorAll(".card");
const content=document.getElementById("content");
const chartEl=document.getElementById("chart");
const modeSel = document.getElementById("mode");

let chart;

/* INIT */
bulanArr.forEach((b,i)=>bulanSel.innerHTML+=`<option value="${i+1}">${b}</option>`);
const now=new Date().getFullYear();
for(let y=2022;y<=now+1;y++) tahunSel.innerHTML+=`<option ${y===now?"selected":""}>${y}</option>`;

const show=v=>loading.classList.toggle("show",v);

/* BUILD TANGGAL */
function buildTanggal(){
  const days=new Date(tahunSel.value,bulanSel.value,0).getDate();
  let th="<th>Jenis</th>", num="<td>Numerator</td>", den="<td>Denumerator</td>";

  for(let i=1;i<=days;i++){
    th+=`<th>${i}</th>`;
    num+=`<td><input data-t="${i}" data-f="num"></td>`;
    den+=`<td><input data-t="${i}" data-f="den"></td>`;
  }
  tglHeader.innerHTML=th;
  numRow.innerHTML=num;
  denRow.innerHTML=den;
}

/* LOAD */
function loadData(){
  show(true);

  fetch(`${API}?indikator=${indikator}&bulan=${bulanSel.value}&tahun=${tahunSel.value}&mode=${modeSel.value}`)
  .then(r=>r.json())
  .then(d=>{

    // RESET
    let labels = [];
    let nums   = [];
    let dens   = [];

    // RINGKASAN (PAKAI DARI API)
    // ===== RINGKASAN =====
    const TARGET = 85; // isi target sesuai indikator kamu

    const cap = d.totalDen
      ? (d.totalNum / d.totalDen) * 100
      : 0;

    document.getElementById("targetVal").innerText = TARGET + "%";
    document.getElementById("persen").innerText = cap.toFixed(2) + "%";
    document.getElementById("Totalpasien").innerText = d.totalDen || 0;

    if(modeSel.value === "harian"){
      buildTanggal();
      document.querySelectorAll("[data-t]").forEach(i=>i.value="");

      d.chart.forEach(x=>{
        const numInp = document.querySelector(`[data-t="${x.key}"][data-f="num"]`);
        const denInp = document.querySelector(`[data-t="${x.key}"][data-f="den"]`);

        if(numInp) numInp.value = x.num;
        if(denInp) denInp.value = x.den;

        labels.push(x.key);
        nums.push(x.num);
        dens.push(x.den);
      });

    } else {
      // ===== MODE TAHUNAN =====
      tglHeader.innerHTML="<th>Bulan</th>";
      numRow.innerHTML="<td>Numerator</td>";
      denRow.innerHTML="<td>Denumerator</td>";

      bulanArr.forEach((b,i)=>{
        const x = d.chart.find(v=>v.key===i+1) || {num:0,den:0};

        tglHeader.innerHTML += `<th>${b}</th>`;
        numRow.innerHTML += `<td>${x.num}</td>`;
        denRow.innerHTML += `<td>${x.den}</td>`;

        labels.push(b);
        nums.push(x.num);
        dens.push(x.den);
      });
    }

    if(chart) chart.destroy();
    chart = new Chart(chartEl,{
      type:"bar",
      data:{
        labels,
        datasets:[
          {label:"Numerator",data:nums},
          {label:"Denumerator",data:dens}
        ]
      },
      options:{
        responsive:true,
        maintainAspectRatio:false
      }
    });
  })
  .finally(()=>{
    show(false);
    content.classList.add("show");
    cards.forEach((c,i)=>setTimeout(()=>c.classList.add("show"),i*120));
  });
}

function toggleImut(){
  const sub = document.getElementById("imutSubmenu");
  const arrow = document.getElementById("imutArrow");

  sub.classList.toggle("show");
  arrow.classList.toggle("rotate");
}

/* SIMPAN */
async function simpan(){
  show(true);
  for(const inp of document.querySelectorAll('[data-f="num"]')){
    const t=inp.dataset.t;
    const num=inp.value;
    const den=document.querySelector(`[data-t="${t}"][data-f="den"]`).value;
    if(num==="" && den==="") continue;

    await fetch(API,{method:"POST",body:JSON.stringify({
      indikator, tahun:tahunSel.value, bulan:bulanSel.value,
      tgl:Number(t), num:Number(num)||0, den:Number(den)||0
    })});
  }
  await loadData();
  show(false);
  alert("âœ… Data berhasil disimpan");
}

/* EVENT */
bulanSel.onchange=()=>{buildTanggal();loadData();}
tahunSel.onchange=()=>{buildTanggal();loadData();}
window.onload=()=>{buildTanggal();loadData();}

/* LOGOUT */
function logout(){
  if(confirm("Logout?")){
    sessionStorage.removeItem("adminLogin");
    location.href="admin_index.html";
  }
}
</script>

</body>
</html>
