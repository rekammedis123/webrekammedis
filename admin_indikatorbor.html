<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<title>Admin Indikator | Medical Record</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" href="logorekammedis.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
:root{
  --green:#329951;
  --green-dark:#329951;
  --green-soft:#ffffff;
  --bg:#ffffff;
  --text:#329951;
  --line:#e5e7eb;
}
*{box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{margin:0;background:var(--bg)}
.layout{display:flex;min-height:100vh}

/* ===== SIDEBAR ===== */
.sidebar{
  width:260px;
  background:linear-gradient(180deg,#16a34a,#15803d);
  color:#fff;
  padding:25px 20px;
}
.brand{text-align:center;margin-bottom:40px}
.brand i{font-size:42px;margin-bottom:10px}
.brand h2{margin:0;font-size:20px;font-weight:600}

.menu a{
  display:flex;align-items:center;gap:14px;
  padding:14px 18px;margin-bottom:14px;
  color:#ffffff;text-decoration:none;
  border-radius:14px;
  transition:.3s;
}
.menu a:hover,.menu a.active{
  background:rgba(255,255,255,.18);
  transform:translateX(6px);
}

/* ===== CONTENT (ANIMASI AMAN) ===== */
.content{
  flex:1;
  padding:35px;
  opacity:0;
  transform:translateY(18px);
  transition:.6s ease;
}
.content.show{
  opacity:1;
  transform:none;
}

.header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:30px;
}
.header h1{margin:0;color:var(--text)}
.user{
  display:flex;
  gap:10px;
  align-items:center;
}
.logout{
  background:#ef4444;
  color:#fff;
  border:none;
  padding:10px 16px;
  border-radius:999px;
  cursor:pointer;
  font-size:13px;
  font-weight:600;
  display:flex;
  align-items:center;
  gap:8px;
  transition:.3s;
}
.logout:hover{
  background:#dc2626;
  transform:translateY(-2px);
}


/* ===== CARD (SEMBUL) ===== */
.card{
  background:#fff;
  border-radius:18px;
  padding:26px;
  margin-bottom:25px;
  box-shadow:0 10px 25px rgba(0,0,0,.08);

  opacity:0;
  transform:translateY(24px) scale(.98);
  transition:.55s ease;
}
.card.show{
  opacity:1;
  transform:none;
}
.card h3{margin-top:0;color:var(--green-dark)}

/* ===== FORM ===== */
label{font-size:13px;color:#065f46}
input,select{
  width:100%;
  padding:11px 12px;
  border-radius:10px;
  border:1px solid var(--line);
  margin:6px 0 14px;
}

/* ===== TABLE ===== */
table{width:100%;border-collapse:collapse}
th,td{
  border:1px solid var(--line);
  padding:6px;
  text-align:center;
}
th{background:var(--green);color:#fff}
.good{background:#dcfce7}
.warn{background:#fff7cd}
.bad{background:#fee2e2}

/* ===== BUTTON ===== */
button.primary{
  background:var(--green);
  color:#fff;
  border:none;
  padding:12px 20px;
  border-radius:12px;
  font-weight:600;
  cursor:pointer;
}
button.primary:hover{background:var(--green-dark)}
button.secondary{
  background:#2563eb;
  color:#fff;
  border:none;
  padding:12px 20px;
  border-radius:12px;
  cursor:pointer;
}

/* ===== FOOTER ===== */
footer{
  text-align:center;
  font-size:13px;
  color:#065f46;
  margin-top:40px;
}

/* ===== RESPONSIVE ===== */
@media(max-width:900px){
  .layout{flex-direction:column}
  .sidebar{width:100%}
}

/* ===== LOADING (FIXED) ===== */
.loading{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.25);
  display:flex;
  align-items:center;
  justify-content:center;
  z-index:9999;
  opacity:0;
  pointer-events:none;
  transition:.3s;
}
.loading.show{
  opacity:1;
  pointer-events:auto;
}
.spinner{
  width:30px;height:30px;
  border:3px solid #bbf7d0;
  border-top:3px solid var(--green);
  border-radius:50%;
  animation:spin 1s linear infinite;
}
@keyframes spin{to{transform:rotate(360deg)}}

/* ===== FADE (ASLI, TIDAK DIUBAH) ===== */
.fade{
  opacity:0;
  transform:translateY(10px);
  transition:.4s;
}
.fade.show{
  opacity:1;
  transform:none;
}

/* ===== TOAST ===== */
.toast{
  position:fixed;
  bottom:30px;
  right:30px;
  background:var(--green);
  color:#fff;
  padding:14px 20px;
  border-radius:14px;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow:0 10px 25px rgba(0,0,0,.2);
  opacity:0;
  transform:translateY(20px);
  transition:.4s;
  z-index:9999;
}
.toast.show{
  opacity:1;
  transform:none;
}
</style>
</head>
   
</div>
<div class="loading" id="loading"><div class="spinner"></div></div>
<div class="toast" id="toast"><i class="fas fa-check-circle"></i> Data berhasil disimpan</div>

<body>
<div class="layout">

<aside class="sidebar">
  <div class="brand">
    <i class="fas fa-notes-medical"></i>
    <h2>ADMIN MR</h2>
  </div>
  <nav class="menu">
    <a href="admin_index.html"><i class="fas fa-gauge-high"></i> Dashboard</a>
    <a href="admin_regulasi.html"><i class="fas fa-file-medical"></i> Regulasi</a>
    <a href="admin_kunjungan.html"><i class="fas fa-chart-simple"></i> Kunjungan Pasien</a>
    <a href="admin_jadwal.html"><i class="fas fa-calendar-check"></i> Jadwal</a>
    <a href="admin_pemusnahan.html"><i class="fas fa-calendar-check"></i> Pemusnahan</a>
    <a class="active"><i class="fas fa-chart-simple"></i> Indikator</a>
  </nav>
</aside>

<main class="content" id="content">

<div class="header">
  <h1>Indikator Rawat Inap</h1>
  <div style="display:flex;gap:12px;align-items:center">
    <div class="user">
      <i class="fas fa-user-shield"></i> Admin
    </div>
    <button class="logout" onclick="logout()">
      <i class="fas fa-right-from-bracket"></i> Logout
    </button>
  </div>
</div>

<div class="card">
<h3>Input Data Indikator</h3>
<label>Tahun</label>
<select id="tahun"></select>

<table id="inputTable">
<thead>
<tr><th>Bulan</th><th>TT</th><th>HP</th><th>BOR</th><th>LOS</th><th>TOI</th><th>BTO</th></tr>
</thead>
<tbody></tbody>
</table><br>

<button class="primary" onclick="simpan()">ðŸ’¾ Simpan</button>
<button class="secondary">ðŸ“¤ Export Excel</button>
</div>

<div class="card">
<h3 id="judulTabel"></h3>
<table>
<thead>
<tr><th>Bulan</th><th>TT</th><th>HP</th><th>BOR</th><th>LOS</th><th>TOI</th><th>BTO</th></tr>
</thead>
<tbody id="tabelData"></tbody>
</table>
</div>

<div class="card">
<h3 id="judulGrafik"></h3>
<div style="height:420px"><canvas id="chart"></canvas></div>
</div>

<footer>Â© 2025 Admin Medical Record RSU An Ni'mah</footer>
</main>
</div>

<script>
if(sessionStorage.getItem("adminLogin") !== "true"){
  window.location.href = "admin_index.html";
}
const URL="https://script.google.com/macros/s/AKfycbyS6F1g4_EA2pdQywCymutFVjcAWhD0qoZGVkrACZPC97cENoWdh7r6vWQ7DihV14XD/exec";
const bulan=["Jan","Feb","Mar","Apr","Mei","Jun","Jul","Agu","Sep","Okt","Nov","Des"];
const TARGET={BOR:[60,85],LOS:[6,9],TOI:[1,3],BTO:[40,999]};
const tbody=document.querySelector("#inputTable tbody");
const chartEl=document.getElementById("chart");
const loading=document.getElementById("loading");
const toast=document.getElementById("toast");
const content=document.getElementById("content");
const cards=document.querySelectorAll(".card");

bulan.forEach(b=>{
  tbody.innerHTML+=`
  <tr>
    <td>${b}</td>
    <td><input data-b="${b}" data-f="tt"></td>
    <td><input data-b="${b}" data-f="hp"></td>
    <td><input data-b="${b}" data-f="bor"></td>
    <td><input data-b="${b}" data-f="los"></td>
    <td><input data-b="${b}" data-f="toi"></td>
    <td><input data-b="${b}" data-f="bto"></td>
  </tr>`;
});

function showLoading(){loading.classList.add("show")}
function hideLoading(){loading.classList.remove("show")}
function showToast(){toast.classList.add("show");setTimeout(()=>toast.classList.remove("show"),2500)}

function simpan(){
  showLoading();
  const th=tahun.value,data=[];
  bulan.forEach(b=>{
    const o={tahun:th,bulan:b};
    document.querySelectorAll(`[data-b="${b}"]`).forEach(i=>o[i.dataset.f] = parseIDNumber(i.value));
    data.push(o);
  });
  fetch(URL,{method:"POST",body:JSON.stringify({bulk:true,data})})
    .then(()=>{loadData();showToast()});
}
function parseIDNumber(val){
  if(!val) return 0;
  return Number(
    val
      .toString()
      .replace(/\./g, "")   // hapus titik ribuan
      .replace(",", ".")    // koma â†’ desimal
  ) || 0;
}
function formatID(val){
  if(val === "" || val === null || isNaN(val)) return "0";
  return Number(val).toLocaleString("id-ID");
}
function formatID2(val){
  if(val === "" || val === null || isNaN(val)) return "0,00";
  return Number(val).toLocaleString("id-ID", {
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
}

let chart;

function loadData(){
  showLoading();

  fetch(URL+"?tahun="+tahun.value)
    .then(r=>r.json())
    .then(d=>{

      isiInputDariServer(d);

      let html="";
      let bor=[], los=[], toi=[], bto=[];

      bulan.forEach(b=>{
        const x = d.find(i=>i.bulan===b) || {};

        html+=`
        <tr>
          <td>${b}</td>
          <td>${formatID(x.tt)}</td>
          <td>${formatID(x.hp)}</td>
          <td class="${x.bor<60?'bad':x.bor>85?'warn':'good'}">${formatID2(x.bor)}</td>
          <td class="${x.los<6?'bad':x.los>9?'warn':'good'}">${formatID2(x.los)}</td>
          <td class="${x.toi<1?'bad':x.toi>3?'warn':'good'}">${formatID2(x.toi)}</td>
          <td class="${x.bto<40?'bad':'good'}">${formatID2(x.bto)}</td>
        </tr>
        `;

        bor.push(x.bor||0);
        los.push(x.los||0);
        toi.push(x.toi||0);
        bto.push(x.bto||0);
      });

      tabelData.innerHTML = html;
      judulTabel.innerText = "Rekap Tahun " + tahun.value;
      judulGrafik.innerText = "Grafik Tahun " + tahun.value;

      if(chart) chart.destroy();

      chart = new Chart(chartEl,{
  data:{
    labels:bulan,
    datasets:[
      {
        type:"bar",
        label:"BOR (%)",
        data:bor,
        backgroundColor:"rgba(22,163,74,0.6)",
        yAxisID:"y",
        order:1
      },
      {
        type:"line",
        label:"LOS",
        data:los,
        borderColor:"#2563eb",
        tension:0.3,
        yAxisID:"y1",
        order:2
      },
      {
        type:"line",
        label:"TOI",
        data:toi,
        borderColor:"#dc2626",
        tension:0.3,
        yAxisID:"y1",
        order:2
      },
      {
        type:"line",
        label:"BTO",
        data:bto,
        borderColor:"#ca8a04",
        tension:0.3,
        yAxisID:"y1",
        order:2
      }
    ]
  },
  options:{
    responsive:true,
    maintainAspectRatio:false,
    scales:{
      y:{
        position:"left",
        title:{ display:true, text:"BOR (%)" },
        min:0,
        max:100
      },
      y1:{
        position:"right",
        title:{ display:true, text:"LOS / TOI / BTO" },
        grid:{ drawOnChartArea:false },
        min:0
      }
    }
  }
});

      hideLoading();
    });
}

function isiInputDariServer(data){
  bulan.forEach(b=>{
    const x = data.find(i=>i.bulan===b) || {};
    document.querySelectorAll(`[data-b="${b}"]`).forEach(inp=>{
      const v = x[inp.dataset.f] ?? 0;

      inp.value = ["bor","los","toi","bto"].includes(inp.dataset.f)
        ? formatID2(v)
        : formatID(v);
    });
  });
}
const tahunSelect = document.getElementById("tahun");

function generateTahun(start = 2020, future = 1){
  const now = new Date().getFullYear();
  for(let y = start; y <= now + future; y++){
    const opt = document.createElement("option");
    opt.value = y;
    opt.textContent = y;
    if(y === now) opt.selected = true;
    tahunSelect.appendChild(opt);
  }
}

generateTahun(2020, 1); // 2020 s/d tahun depan
window.addEventListener("load",()=>{
  content.classList.add("show");
  cards.forEach((c,i)=>setTimeout(()=>c.classList.add("show"),i*150));
  loadData();
});
tahun.onchange=loadData;

function logout(){
  if(confirm("Yakin ingin logout?")){
    sessionStorage.removeItem("adminLogin");
    window.location.href = "admin_index.html";
  }
}
</script>
</body>
</html>
